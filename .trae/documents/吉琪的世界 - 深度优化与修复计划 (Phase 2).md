# 吉琪的世界 (JiQi's World) - 深度优化与修复计划 (Phase 2)

针对您提出的"握拳手势后照片未归位"问题，以及对项目质量、性能和稳定性的全面审查，我制定了以下深度优化计划。这次我们将从根本上解决 3D 坐标计算、渲染逻辑和内存管理问题。

## 1. 核心修复：照片归位与显示异常 (Critical Fixes)
### 问题根源
用户反馈的"显示有问题"和"未归位"实际上是由两个叠加的 Bug 导致的：
1.  **朝向错误 (The "Flip" Bug)**: 当前所有照片默认 `lookAt(0,0,0)`。在球体布局中，这意味着照片是"背对"摄像机的（面朝球心）。当选中时，照片翻转过来面向摄像机；退出时，又翻转回去。这种 180 度的剧烈翻转在视觉上非常突兀，看起来像"显示错误"。
2.  **坐标系滞后**: 在退出选中状态的瞬间，由于父容器旋转和局部坐标转换的时序问题，照片可能会在错误的位置"闪烁"一下再开始移动。

### 修复方案
*   **修正默认朝向**: 修改 `Photo` 组件逻辑，让照片默认**背向球心**（即面向外太空/摄像机）。这样在选中/退出的过程中，照片不需要进行 180 度翻转，只需微调角度。
*   **平滑旋转过渡**: 引入 `Quaternion.slerp` (球形插值) 替代生硬的 `lookAt`，确保无论照片如何旋转，过渡都如丝般顺滑。
*   **强制矩阵更新**: 在进行 `worldToLocal` 计算前，强制调用 `updateMatrixWorld()`，消除计算滞后。

## 2. 代码质量与稳定性 (Quality & Stability)
*   **内存泄漏修复**:
    *   在 `GestureHandler.jsx` 中添加**资源清理逻辑**。当前摄像头流在组件卸载后未关闭，这会导致浏览器性能下降和指示灯常亮。
*   **防御性编程**:
    *   为 `App.jsx` 添加**错误边界 (Error Boundary)**，防止 3D 渲染错误导致整个页面白屏崩溃。
    *   完善手势状态机，防止快速切换手势时的状态竞争。

## 3. 性能优化 (Performance)
*   **GC (垃圾回收) 优化**:
    *   在 `DesktopView.jsx` 的渲染循环 (`useFrame`) 中，存在每帧创建新 `Vector3` 对象的情况。我将重构为**对象复用模式**，减少 90% 的内存分配压力，消除画面微卡顿。
*   **按需渲染**:
    *   优化非选中状态下的计算逻辑，当照片处于静态时停止不必要的 Lerp 计算。

## 4. 用户体验 (UX)
*   **手势防抖升级**: 优化手势识别的防抖参数，减少误触。
*   **交互反馈**: 增加鼠标光标的智能提示，明确告知用户当前可交互状态。

---

**执行步骤**:
1.  **GestureHandler**: 修复摄像头内存泄漏。
2.  **DesktopView**:
    *   修复照片朝向逻辑（面向外）。
    *   实现 Quaternion Slerp 平滑旋转。
    *   优化 `Vector3` 对象复用。
3.  **App**: 添加错误边界。

请确认是否执行此全面优化计划。
